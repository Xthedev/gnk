// Import.
const fs = require('fs');
const jcopy = require('jcopy');
const Record = require('./entities/record');

// Constants.
const FILE_ENCODING = 'utf8';
const EMPTY_RECORDS = [];
const EMPTY_DATA_STRUCTURE = {
  records: []
};
const ERROR_INCORRECT_FILTER_TYPE = 'Filter should be a function.';

/**
 * Data.
 */
class Data {
  /**
   * Data constructor.
   * @param {string} filePath File path.
   * @param {object} [options] Options.
   * @param {boolean} [options.async] Async saving to file.
   * @param {number} [options.asyncTimeout] Async saving timeout in milliseconds.
   * @param {boolean} [options.logs] Logs indicator.
   */
  constructor(filePath, { async = false, asyncTimeout = 1000, logs = false } = {}) {
    this.filePath = filePath;
    this.fileRecords = [];
    this.async = async;
    this.asyncTimeout = asyncTimeout;
    this.logs = logs;
    this._saving = false;
    this._otherSavingNeeded = false;
    this._createFileIfNotExist();
    this._loadFileRecords();
  }

  /**
   * Get data.
   * @param {function} [filter] Filter function.
   * @return {Array} Data.
   */
  get(filter) {
    this._throwErrorIfIncorrectFilter(filter);
    const normalizedFilter = this._normalizeFilter(filter);
    const allData = this._getAllData();
    const data = allData.filter(normalizedFilter);
    return data;
  }

  /**
   * Add data.
   * @param {object} data Data.
   */
  add(data) {
    const record = new Record(data);
    this.fileRecords.push(record);
    this._saveFileRecords();
  }

  /**
   * Add data bulk.
   * @param {object[]} list List.
   */
  addBulk(list) {
    for (let i = 0; i < list.length; i++) {
      const data = list[i];
      const record = new Record(data);
      this.fileRecords.push(record);
    }
    this._saveFileRecords();
  }

  /**
   * Update data.
   * @param {function} filter Filter function.
   * @param {object} data Data.
   */
  update(filter, data) {
    this._throwErrorIfIncorrectFilter(filter);
    const normalizedFilter = this._normalizeFilter(filter);
    const allData = this._getAllData();
    for (let i = 0; i < allData.length; i++) {
      if (normalizedFilter(allData[i])) {
        this.fileRecords[i] = new Record(data);
      }
    }
    this._saveFileRecords();
  }

  /**
   * Remove data.
   * @param {function} filter Filter function.
   */
  remove(filter) {
    this._throwErrorIfIncorrectFilter(filter);
    const normalizedFilter = this._normalizeFilter(filter);
    this.fileRecords = this.fileRecords.filter(v => !normalizedFilter(v.data));
    this._saveFileRecords();
  }

  /**
   * Get all data.
   * @private
   * @return {Array} All data.
   */
  _getAllData() {
    const records = jcopy(this.fileRecords);
    const allData = records.map(v => v.data);
    return allData;
  }

  /**
   * Throw error if incorrect filter.
   * @param {function} [filter] Filter function.
   */
  _throwErrorIfIncorrectFilter(filter) {
    const isCorrectFilter = this._isCorrectFilter(filter);
    if (!isCorrectFilter) {
      throw new TypeError(ERROR_INCORRECT_FILTER_TYPE);
    }
  }

  /**
   * Is correct filter.
   * @private
   * @param {function} [filter] Filter function.
   * @return {boolean} Is correct filter indicator.
   */
  _isCorrectFilter(filter) {
    if (typeof filter !== 'function' && typeof filter !== 'undefined') {
      return false;
    }
    return true;
  }

  /**
   * Normalize filter.
   * @param {function} [filter] Filter function.
   * @return {function} Filter function.
   */
  _normalizeFilter(filter) {
    const normalizedFilter = typeof filter === 'undefined' ? (() => {
      return true;
    }) : filter;
    return normalizedFilter;
  }

  /**
   * Save file records.
   * @private
   */
  _saveFileRecords() {
    // Handle if async saving.
    if (this.async) {
      this._initAsyncSaving();
      return;
    }

    // Handle if sync saving.
    const fileContent = this._createFileContent();
    fs.writeFileSync(this.filePath, fileContent, { encoding: FILE_ENCODING });
    if (this.logs) console.log('JSON Records file saved (' + this.filePath + ').');
  }

  /**
   * Init async saving.
   * @private
   */
  _initAsyncSaving() {
    // Handle if saving is in progress.
    if (this._saving) {
      this._otherSavingNeeded = true;
      return;
    }

    // Handle if saving is not in progress.
    this._saving = true;
    setTimeout(() => {
      const fileContent = this._createFileContent();
      fs.writeFileSync(this.filePath, fileContent, { encoding: FILE_ENCODING });
      if (this.logs) console.log('JSON Records file saved (' + this.filePath + ').');
      this._saving = false;

      if (this._otherSavingNeeded) {
        this._otherSavingNeeded = false;
        this._saveFileRecords();
      }
    }, this.asyncTimeout);
  }

  /**
   * Load file records.
   * @private
   */
  _loadFileRecords() {
    this.fileRecords = this._getFileRecords();
  }

  /**
   * Create file records.
   * @param {Array} recordsData Records data.
   */
  _createFileRecords(recordsData) {
    const records = recordsData.map(v => new Record(v));
    return records;
  }

  /**
   * Get file records.
   * @private
   * @return {Array} File records.
   */
  _getFileRecords() {
    const emptyRecords = this._getEmptyRecords();
    const fileContentObject = this._getFileContentObject();
    const fileRecords = fileContentObject.records || emptyRecords;
    return fileRecords;
  }

  /**
   * Get file content object.
   * @private
   * @return {object} File content object.
   */
  _getFileContentObject() {
    const fileContent = this._getFileContent();
    const fileContentObject = JSON.parse(fileContent);
    return fileContentObject;
  }

  /**
   * Create file content.
   * @private
   * @return {string} File content.
   */
  _createFileContent() {
    const dataStructure = this._getEmptyDataStructure();
    dataStructure.records = this.fileRecords;
    const fileContent = JSON.stringify(dataStructure);
    return fileContent;
  }

  /**
   * Get file content.
   * @private
   * @return {string} File content.
   */
  _getFileContent() {
    const fileContent = fs.readFileSync(this.filePath, { encoding: FILE_ENCODING });
    return fileContent;
  }

  /**
   * Create file if not exist.
   * @private
   */
  _createFileIfNotExist() {
    if (!fs.existsSync(this.filePath)) {
      this._dropFileRecords();
    }
  }

  /**
   * Drop file records.
   * @private
   */
  _dropFileRecords() {
    const emptyDataStructure = this._getEmptyDataStructure();
    fs.writeFileSync(this.filePath, JSON.stringify(emptyDataStructure), { encoding: FILE_ENCODING });
    if (this.logs) console.log('JSON Records file saved (' + this.filePath + ').');
  }

  /**
   * Get empty data structure.
   * @private
   * @return {object} Empty data structure.
   */
  _getEmptyDataStructure() {
    const emptyDataStructure = jcopy(EMPTY_DATA_STRUCTURE);
    return emptyDataStructure;
  }

  /**
   * Get empty records.
   * @private
   * @return {Array} Empty records.
   */
  _getEmptyRecords() {
    const emptyRecords = jcopy(EMPTY_RECORDS);
    return emptyRecords;
  }
}

// Export.
module.exports = Data;
